name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  docker-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Create .env file
      run: |
        cp .env.example .env
        echo "APP_KEY=" >> .env

    - name: Build and start containers
      run: |
        docker-compose up -d
        sleep 30

    - name: Install dependencies
      run: docker-compose exec -T app composer install --no-interaction

    - name: Generate app key
      run: docker-compose exec -T app php artisan key:generate

    - name: Wait for database
      run: |
        timeout 60 bash -c 'until docker-compose exec -T db mysql -u root -psecret -e "SELECT 1"; do sleep 2; done'

    - name: Run migrations
      run: docker-compose exec -T app php artisan migrate --force

    - name: Run tests
      id: test
      run: |
        echo "RESULT<<EOF" >> $GITHUB_OUTPUT
        docker-compose exec -T app php artisan test 2>&1 | tee test-output.txt
        echo "EOF" >> $GITHUB_OUTPUT
        
        if docker-compose exec -T app php artisan test >/dev/null 2>&1; then
          echo "SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "SUCCESS=false" >> $GITHUB_OUTPUT
        fi

    - name: Generate test summary
      run: |
        echo "## 🧪 テスト結果" > docker-test-report.md
        echo "" >> docker-test-report.md
        if [ "${{ steps.test.outputs.SUCCESS }}" == "true" ]; then
          echo "✅ **全テスト成功**" >> docker-test-report.md
          echo "" >> docker-test-report.md
          echo "🚀 EG-R2 Laravel サンプルが正常に動作しています！" >> docker-test-report.md
        else
          echo "❌ **テスト失敗**" >> docker-test-report.md
        fi
        echo "" >> docker-test-report.md
        echo "### 📊 テスト詳細" >> docker-test-report.md
        echo "\`\`\`" >> docker-test-report.md
        tail -20 test-output.txt >> docker-test-report.md
        echo "\`\`\`" >> docker-test-report.md
        echo "" >> docker-test-report.md
        echo "### 🔧 実行環境" >> docker-test-report.md
        echo "- PHP: \`$(docker-compose exec -T app php -v | head -1)\`" >> docker-test-report.md
        echo "- Laravel: \`$(docker-compose exec -T app php artisan --version)\`" >> docker-test-report.md
        echo "- EG-R2: Schema-driven development enabled" >> docker-test-report.md

    - name: Comment PR with Docker results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('docker-test-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });

    - name: Cleanup
      if: always()
      run: docker-compose down -v